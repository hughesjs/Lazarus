name: CI Pipeline
on:
  pull_request:
    branches:
      - master
    paths:
      - "src/**"
      - ".github/workflows/ci-pipeline.yml"
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-main:
    name: Build Solution
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.sanitize_version.outputs.sanitized_version }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"
          dotnet-quality: "preview"

      - name: Get Next Semantic Version
        id: semver
        uses: ietf-tools/semver-action@v1.9.0
        with:
          token: ${{ github.token }}
          branch: ${{ github.head_ref }}
          patchList: fix, bugfix, perf, refactor, test, tests, chore, patch
          majorList: major, breaking
          minorList: minor, feat, feature
          noVersionBumpBehavior: patch
          fallbackTag: 'v0.0.0'

      - name: Sanitize Semantic Version
        id: sanitize_version
        run: |
          SANITISED_BRANCH=$(echo "${{ github.head_ref }}" | sed 's/[^a-zA-Z0-9._-]/-/g')
          VERSION="${{ steps.semver.outputs.nextStrict }}-$SANITISED_BRANCH-${{ github.run_number }}"
          echo "sanitized_version=$VERSION" >> $GITHUB_OUTPUT

      - name: Restore Dependencies
        working-directory: src
        run: dotnet restore Lazarus.slnx

      - name: Build Solution
        working-directory: src
        run: dotnet build Lazarus.slnx -c Release -p:Version=${{ steps.sanitize_version.outputs.sanitized_version }}

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: build-output
          path: ./src

  unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: build-main
    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v6
        with:
          name: build-output
          path: ./build

      - name: Set up .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"
          dotnet-quality: "preview"

      - name: Run Unit Tests
        timeout-minutes: 5
        working-directory: ./build/Lazarus.Tests.Unit/bin/Release/net10.0
        run: dotnet Lazarus.Tests.Unit.dll

  architecture-tests:
    name: Run Architecture Tests
    runs-on: ubuntu-latest
    needs: build-main
    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v6
        with:
          name: build-output
          path: ./build

      - name: Set up .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"
          dotnet-quality: "preview"

      - name: Run Architecture Tests
        timeout-minutes: 5
        working-directory: ./build/Lazarus.Tests.Architecture/bin/Release/net10.0
        run: dotnet Lazarus.Tests.Architecture.dll

  healthchecks-tests:
    name: Run HealthChecks Tests
    runs-on: ubuntu-latest
    needs: build-main
    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v6
        with:
          name: build-output
          path: ./build

      - name: Set up .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"
          dotnet-quality: "preview"

      - name: Run HealthChecks Tests
        timeout-minutes: 5
        working-directory: ./build/Lazarus.Extensions.HealthChecks.Tests/bin/Release/net10.0
        run: dotnet Lazarus.Extensions.HealthChecks.Tests.dll

  healthchecks-architecture-tests:
    name: Run HealthChecks Architecture Tests
    runs-on: ubuntu-latest
    needs: build-main
    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v6
        with:
          name: build-output
          path: ./build

      - name: Set up .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"
          dotnet-quality: "preview"

      - name: Run HealthChecks Architecture Tests
        timeout-minutes: 5
        working-directory: ./build/Lazarus.Extensions.HealthChecks.Tests.Architecture/bin/Release/net10.0
        run: dotnet Lazarus.Extensions.HealthChecks.Tests.Architecture.dll

  package:
    name: Package Pre-release
    runs-on: ubuntu-latest
    needs:
      - build-main
      - unit-tests
      - architecture-tests
      - healthchecks-tests
      - healthchecks-architecture-tests
    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v6
        with:
          name: build-output
          path: ./build

      - name: Set up .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"
          dotnet-quality: "preview"

      - name: Restore Dependencies
        working-directory: ./build
        run: dotnet restore Lazarus/Lazarus.csproj

      - name: Build and Package
        working-directory: ./build
        run: dotnet pack ./Lazarus/Lazarus.csproj --no-build --no-restore -o ./artifacts -p:Version=${{ needs.build-main.outputs.version }}

      - name: Publish to GitHub Packages
        if: github.event.pull_request.head.repo.fork == false
        working-directory: ./build
        run: |
          dotnet nuget add source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
          --name github \
          --username "USERNAME" \
          --password ${{ secrets.GITHUB_TOKEN }} \
          --store-password-in-clear-text

          dotnet nuget push "./artifacts/*.nupkg" \
            --source github \
            --api-key ${{ secrets.GITHUB_TOKEN }}
