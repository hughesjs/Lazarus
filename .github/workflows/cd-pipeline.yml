name: CD Pipeline
on:
  push:
    branches:
      - master
    paths:
      - "src/Lazarus/**"
      - "!src/Lazarus.Tests/**"
      - "!**/*.md"
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  version:
    name: Get Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.semver-outputs.outputs.version }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get Next Semantic Version
        id: semver
        uses: ietf-tools/semver-action@v1.9.0
        with:
          token: ${{ github.token }}
          branch: master
          patchList: fix, bugfix, perf, refactor, test, tests, chore, patch
          majorList: major, breaking
          minorList: minor, feat, feature
          noVersionBumpBehavior: patch
          noNewCommitBehavior: error

      - name: Output SemVer
        id: semver-outputs
        run: echo "version=${{ steps.semver.outputs.nextStrict }}" >> $GITHUB_OUTPUT

  build-library:
    name: Build ${{ matrix.library-name }}
    runs-on: ubuntu-latest
    needs: version
    strategy:
      matrix:
        include:
          - library-name: "Lazarus"
            project-path: "Lazarus/Lazarus.csproj"
            artifact-name: "lazarus-build-output"
            package-artifact-name: "lazarus-package-output"
          - library-name: "HealthChecks"
            project-path: "Lazarus.Extensions.HealthChecks/Lazarus.Extensions.HealthChecks.csproj"
            artifact-name: "healthchecks-build-output"
            package-artifact-name: "healthchecks-package-output"
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Set up .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"
          dotnet-quality: "preview"

      - name: Restore ${{ matrix.library-name }} Dependencies
        working-directory: src
        run: dotnet restore ${{ matrix.project-path }}

      - name: Build ${{ matrix.library-name }}
        working-directory: src
        run: dotnet build ${{ matrix.project-path }} --output ./build-${{ matrix.artifact-name }} --configuration Release /p:Version=${{ needs.version.outputs.version }}

      - name: Upload ${{ matrix.library-name }} Build Artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.artifact-name }}
          path: ./src/build-${{ matrix.artifact-name }}

      - name: Package ${{ matrix.library-name }}
        working-directory: src
        run: |
          mkdir -p build-${{ matrix.artifact-name }}/artifacts
          dotnet pack ${{ matrix.project-path }} \
          --no-restore \
          --output ./build-${{ matrix.artifact-name }}/artifacts \
          /p:Version=${{ needs.version.outputs.version }} \
          /p:DebugSymbols=false

      - name: Upload ${{ matrix.library-name }} Package Artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.package-artifact-name }}
          path: ./src/build-${{ matrix.artifact-name }}/artifacts/*.nupkg

  build-tests:
    name: Build ${{ matrix.test-name }}
    runs-on: ubuntu-latest
    needs: version
    strategy:
      matrix:
        include:
          - test-name: "Lazarus Unit Tests"
            test-project: "Lazarus.Tests.Unit"
            artifact-name: "test-build-output"
          - test-name: "HealthChecks Unit Tests"
            test-project: "Lazarus.Extensions.HealthChecks.Tests.Unit"
            artifact-name: "healthcheck-unit-test-build-output"
          - test-name: "HealthChecks Integration Tests"
            test-project: "Lazarus.Extensions.HealthChecks.Tests.Integration"
            artifact-name: "healthcheck-integration-test-build-output"
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Set up .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"
          dotnet-quality: "preview"

      - name: Build ${{ matrix.test-name }}
        working-directory: src
        run: dotnet build ${{ matrix.test-project }}/${{ matrix.test-project }}.csproj --output ./build-${{ matrix.artifact-name }} --configuration Release

      - name: Upload ${{ matrix.test-name }} Artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.artifact-name }}
          path: ./src/build-${{ matrix.artifact-name }}

  run-tests:
    name: Run ${{ matrix.test-name }}
    runs-on: ubuntu-latest
    needs:
      - build-library
      - build-tests
    strategy:
      matrix:
        include:
          - test-name: "Lazarus Unit Tests"
            test-project: "Lazarus.Tests.Unit"
            artifact-name: "test-build-output"
            library-artifact: "lazarus-build-output"
          - test-name: "HealthChecks Unit Tests"
            test-project: "Lazarus.Extensions.HealthChecks.Tests.Unit"
            artifact-name: "healthcheck-unit-test-build-output"
            library-artifact: "healthchecks-build-output"
          - test-name: "HealthChecks Integration Tests"
            test-project: "Lazarus.Extensions.HealthChecks.Tests.Integration"
            artifact-name: "healthcheck-integration-test-build-output"
            library-artifact: "healthchecks-build-output"
    steps:
      - name: Set up .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"
          dotnet-quality: "preview"

      - name: Download built library
        uses: actions/download-artifact@v7
        with:
          name: ${{ matrix.library-artifact }}
          path: ./build

      - name: Download ${{ matrix.test-name }} artifact
        uses: actions/download-artifact@v7
        with:
          name: ${{ matrix.artifact-name }}
          path: ./build

      - name: Run ${{ matrix.test-name }}
        timeout-minutes: 5
        working-directory: ./build
        run: dotnet ${{ matrix.test-project }}.dll

  publish-release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs:
      - run-tests
      - version
      - build-library
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Tag commit with new version
        run: |
          NEW_TAG=v${{ needs.version.outputs.version }}
          echo "New tag: $NEW_TAG"
          git tag "$NEW_TAG" || echo "Tag $NEW_TAG already exists"
          git push origin "$NEW_TAG"
          echo "newTag=$NEW_TAG" >> $GITHUB_ENV

      - name: Get previous tag
        id: previousTag
        run: |
          name=$(git --no-pager tag --sort=creatordate --merged ${{ github.ref_name }} | tail -2 | head -1)
          echo "previousTag: $name"
          echo "previousTag=$name" >> $GITHUB_ENV

      - name: Update CHANGELOG
        id: changelog
        uses: requarks/changelog-action@v1
        with:
          token: ${{ github.token }}
          fromTag: ${{ env.newTag }}
          toTag: ${{ env.previousTag }}
          writeToFile: false

      - name: Download Lazarus Package
        uses: actions/download-artifact@v7
        with:
          name: lazarus-package-output
          path: ./artifacts

      - name: Download HealthChecks Package
        uses: actions/download-artifact@v7
        with:
          name: healthchecks-package-output
          path: ./artifacts

      - name: Create Release
        uses: ncipollo/release-action@v1.20.0
        with:
          allowUpdates: true
          draft: false
          makeLatest: true
          tag: ${{ env.newTag }}
          name: ${{ env.newTag }}
          body: ${{ steps.changelog.outputs.changes }}
          token: ${{ github.token }}
          artifacts: "artifacts/*.nupkg"

  push-package:
    name: Push NuGet Packages
    runs-on: ubuntu-latest
    needs:
      - run-tests
      - build-library
    steps:
      - name: Download Lazarus Package
        uses: actions/download-artifact@v7
        with:
          name: lazarus-package-output
          path: ./artifacts

      - name: Download HealthChecks Package
        uses: actions/download-artifact@v7
        with:
          name: healthchecks-package-output
          path: ./artifacts

      - name: Publish to GitHub Packages
        run: |
          dotnet nuget add source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
          --name github \
          --username "username" \
          --password ${{ secrets.GITHUB_TOKEN }} \
          --store-password-in-clear-text

          dotnet nuget push "./artifacts/*.nupkg" \
            --source github \
            --api-key ${{ secrets.GITHUB_TOKEN }}

      - name: NuGet login (OIDC â†’ temp API key)
        uses: NuGet/login@v1
        id: login
        with:
          user: ${{ secrets.NUGET_USER }}

      - name: Publish to NuGet.org
        run: |
          dotnet nuget push "./artifacts/*.nupkg" \
            --source https://api.nuget.org/v3/index.json \
            --api-key ${{steps.login.outputs.NUGET_API_KEY}}

  cleanup-pre-release-builds:
    name: Delete Old ${{ matrix.package-name }} Pre-Releases
    runs-on: ubuntu-latest
    needs:
      - publish-release
      - push-package
    strategy:
      matrix:
        include:
          - package-name: "Lazarus"
          - package-name: "Lazarus.Extensions.HealthChecks"
    steps:
      - uses: actions/delete-package-versions@v5
        with:
          owner: ${{ github.repository_owner }}
          package-name: ${{ matrix.package-name }}
          package-type: "nuget"
          min-versions-to-keep: 0
          delete-only-pre-release-versions: true
